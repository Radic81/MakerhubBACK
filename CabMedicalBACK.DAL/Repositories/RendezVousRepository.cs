using Dapper;
using Npgsql;
using CabMedicalBACK.DAL.Entities;
using CabMedicalBACK.DAL.Interfaces;

namespace CabMedicalBACK.DAL.Repositories
{
    public class RendezVousRepository : IRendezVousRepository
    {
        private readonly NpgsqlConnection _connection;

        public RendezVousRepository(NpgsqlConnection connection)
        {
            _connection = connection;
        }

        public IEnumerable<RendezVous> GetAll()
        {
            const string query = @"
                SELECT
                    ""id_rendez_vous"" AS ""IdRendezVous"",
                    ""date_debut""     AS ""DateDebut"",
                    ""date_fin""       AS ""DateFin"",
                    ""description""    AS ""Description"",
                    ""motif_rdv""      AS ""MotifRdv"",
                    ""id_patient""     AS ""IdPatient"",
                    ""id_utilisateur"" AS ""IdUtilisateur""
                FROM ""rendez_vous"";
            ";

            return _connection.Query<RendezVous>(query);
        }

        public IEnumerable<RendezVous> GetByUtilisateur(int idUtilisateur)
        {
            const string query = @"
                SELECT
                    ""id_rendez_vous"" AS ""IdRendezVous"",
                    ""date_debut""     AS ""DateDebut"",
                    ""date_fin""       AS ""DateFin"",
                    ""description""    AS ""Description"",
                    ""motif_rdv""      AS ""MotifRdv"",
                    ""id_patient""     AS ""IdPatient"",
                    ""id_utilisateur"" AS ""IdUtilisateur""
                FROM ""rendez_vous""
                WHERE ""id_utilisateur"" = @UserId;
            ";

            return _connection.Query<RendezVous>(query, new { UserId = idUtilisateur });
        }

        public RendezVous? GetById(int id)
        {
            const string query = @"
                SELECT
                    ""id_rendez_vous"" AS ""IdRendezVous"",
                    ""date_debut""     AS ""DateDebut"",
                    ""date_fin""       AS ""DateFin"",
                    ""description""    AS ""Description"",
                    ""motif_rdv""      AS ""MotifRdv"",
                    ""id_patient""     AS ""IdPatient"",
                    ""id_utilisateur"" AS ""IdUtilisateur""
                FROM ""rendez_vous""
                WHERE ""id_rendez_vous"" = @Id;
            ";

            return _connection.QuerySingleOrDefault<RendezVous>(query, new { Id = id });
        }

        public int Create(RendezVous rendezVous)
        {
            const string query = @"
                INSERT INTO ""rendez_vous""
                (
                    ""date_debut"",
                    ""date_fin"",
                    ""description"",
                    ""motif_rdv"",
                    ""id_patient"",
                    ""id_utilisateur""
                )
                VALUES
                (
                    @DateDebut,
                    @DateFin,
                    @Description,
                    @MotifRdv,
                    NULLIF(@IdPatient, 0), -- Met NULL si IdPatient vaut 0
                    @IdUtilisateur
                )
                RETURNING ""id_rendez_vous"" AS ""IdRendezVous"";
            ";

            return _connection.QuerySingle<int>(query, new
            {
                rendezVous.DateDebut,
                rendezVous.DateFin,
                rendezVous.Description,
                rendezVous.MotifRdv,
                IdPatient = rendezVous.IdPatient > 0 ? rendezVous.IdPatient : (int?)null,  // Met NULL si IdPatient est 0
                rendezVous.IdUtilisateur
            });
        }

        public bool Update(RendezVous rendezVous)
        {
            const string query = @"
                UPDATE ""rendez_vous""
                SET
                    ""date_debut""     = @DateDebut,
                    ""date_fin""       = @DateFin,
                    ""description""    = @Description,
                    ""motif_rdv""      = @MotifRdv,
                    ""id_patient""     = @IdPatient,
                    ""id_utilisateur"" = @IdUtilisateur
                WHERE ""id_rendez_vous"" = @IdRendezVous;
            ";

            int affectedRows = _connection.Execute(query, new
            {
                rendezVous.DateDebut,
                rendezVous.DateFin,
                rendezVous.Description,
                rendezVous.MotifRdv,
                rendezVous.IdPatient,
                rendezVous.IdUtilisateur,
                rendezVous.IdRendezVous
            });


            return affectedRows > 0;
        }

        public bool Delete(int id)
        {
            // Suppression définitive
            const string query = @"
                DELETE FROM ""rendez_vous""
                WHERE ""id_rendez_vous"" = @Id;
            ";

            int affectedRows = _connection.Execute(query, new { Id = id });
            return affectedRows > 0;
        }
    }
}